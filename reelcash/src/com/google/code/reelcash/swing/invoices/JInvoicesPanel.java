package com.google.code.reelcash.swing.invoices;

import com.google.code.reelcash.ReelcashException;
import com.google.code.reelcash.data.DataRow;
import com.google.code.reelcash.data.ReelcashDataSource;
import com.google.code.reelcash.data.documents.DocumentMediator;
import com.google.code.reelcash.data.documents.DocumentState;
import com.google.code.reelcash.data.documents.InvoiceMediator;
import com.google.code.reelcash.util.MsgBox;
import com.google.code.reelcash.util.ReportingUtils;
import javax.swing.DefaultListModel;
import javax.swing.SwingUtilities;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;

/**
 * This class of panels works as a master/detail view for invoices.
 *
 * @author andrei.olar
 */
public class JInvoicesPanel extends javax.swing.JPanel {

    private static final long serialVersionUID = 5635559986924134535L;

    /** Creates new form JInvoicesPanel */
    public JInvoicesPanel() {
        initComponents();
    }

    private void loadInvoices() {
        DefaultListModel listModel = (DefaultListModel) invoiceList.getModel();
        listModel.removeAllElements();
        for (DataRow row : InvoiceMediator.getInstance().readInvoices()) {
            listModel.addElement(row);
        }
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        invoiceMenu = new javax.swing.JPopupMenu();
        issueInvoiceItem = new javax.swing.JMenuItem();
        masterDetailPane = new javax.swing.JSplitPane();
        masterPane = new javax.swing.JPanel();
        operationBar = new javax.swing.JToolBar();
        addButton = new javax.swing.JButton();
        delButton = new javax.swing.JButton();
        invOpPrevOpSep = new javax.swing.JToolBar.Separator();
        previewButton = new javax.swing.JButton();
        masterListPanel = new javax.swing.JPanel();
        filterField = new javax.swing.JTextField();
        filterButton = new javax.swing.JButton();
        listScroller = new javax.swing.JScrollPane();
        invoiceList = new javax.swing.JList();
        detailsPane = new com.google.code.reelcash.swing.invoices.JInvoiceDetailsPanel();

        issueInvoiceItem.setMnemonic('i');
        issueInvoiceItem.setText(InvoiceResources.getString("issue_invoice_item_text")); // NOI18N
        issueInvoiceItem.setToolTipText(InvoiceResources.getString("issue_invoice_item_tip")); // NOI18N
        issueInvoiceItem.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                issueInvoiceItemActionPerformed(evt);
            }
        });
        invoiceMenu.add(issueInvoiceItem);

        setLayout(new java.awt.BorderLayout());

        masterDetailPane.setDividerLocation(160);
        masterDetailPane.setResizeWeight(0.33);

        masterPane.setLayout(new java.awt.BorderLayout());

        operationBar.setFloatable(false);
        operationBar.setDoubleBuffered(true);

        addButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/google/code/reelcash/images/toolbar/add_small.png"))); // NOI18N
        addButton.setFocusable(false);
        addButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        addButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        addButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                onAddInvoicePerformed(evt);
            }
        });
        operationBar.add(addButton);

        delButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/google/code/reelcash/images/toolbar/delete_small.png"))); // NOI18N
        delButton.setFocusable(false);
        delButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        delButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        delButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                onDeleteInvoicePerformed(evt);
            }
        });
        operationBar.add(delButton);

        invOpPrevOpSep.setToolTipText("");
        invOpPrevOpSep.setSeparatorSize(new java.awt.Dimension(2, 10));
        operationBar.add(invOpPrevOpSep);

        previewButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/google/code/reelcash/images/toolbar/print_preview.png"))); // NOI18N
        previewButton.setMnemonic('v');
        previewButton.setActionCommand("preview");
        previewButton.setFocusable(false);
        previewButton.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        previewButton.setName("preview"); // NOI18N
        previewButton.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        previewButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                onPrintPreviewRequested(evt);
            }
        });
        operationBar.add(previewButton);
        previewButton.getAccessibleContext().setAccessibleName("Preview Invoice");

        masterPane.add(operationBar, java.awt.BorderLayout.PAGE_START);

        masterListPanel.setLayout(new java.awt.GridBagLayout());

        filterField.setMaximumSize(new java.awt.Dimension(1200, 20));
        filterField.setMinimumSize(new java.awt.Dimension(75, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.ipadx = 50;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.LAST_LINE_START;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(15, 15, 0, 5);
        masterListPanel.add(filterField, gridBagConstraints);

        filterButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/com/google/code/reelcash/images/toolbar/filter.png"))); // NOI18N
        filterButton.setMnemonic('f');
        filterButton.setToolTipText("");
        filterButton.setMaximumSize(new java.awt.Dimension(20, 20));
        filterButton.setMinimumSize(new java.awt.Dimension(20, 20));
        filterButton.setPreferredSize(new java.awt.Dimension(20, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.LAST_LINE_START;
        gridBagConstraints.insets = new java.awt.Insets(15, 0, 0, 5);
        masterListPanel.add(filterButton, gridBagConstraints);

        invoiceList.setModel(new DefaultListModel());
        invoiceList.setCellRenderer(new DataRowListCellRenderer(InvoiceResources.getString("invoice_format"), 2,3,7,9));
        invoiceList.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                invoiceListMouseClicked(evt);
            }
        });
        invoiceList.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                onSelectionChanged(evt);
            }
        });
        invoiceList.addAncestorListener(new javax.swing.event.AncestorListener() {
            public void ancestorMoved(javax.swing.event.AncestorEvent evt) {
            }
            public void ancestorAdded(javax.swing.event.AncestorEvent evt) {
                onListAddedOnAncestor(evt);
            }
            public void ancestorRemoved(javax.swing.event.AncestorEvent evt) {
            }
        });
        listScroller.setViewportView(invoiceList);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(5, 15, 15, 5);
        masterListPanel.add(listScroller, gridBagConstraints);

        masterPane.add(masterListPanel, java.awt.BorderLayout.CENTER);

        masterDetailPane.setLeftComponent(masterPane);
        masterDetailPane.setRightComponent(detailsPane);

        add(masterDetailPane, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    private void onListAddedOnAncestor(javax.swing.event.AncestorEvent evt) {//GEN-FIRST:event_onListAddedOnAncestor
        loadInvoices();
    }//GEN-LAST:event_onListAddedOnAncestor

    private void onAddInvoicePerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_onAddInvoicePerformed
        JInvoiceWizard wizard = new JInvoiceWizard();
        wizard.pack();
        wizard.setModal(true);
        wizard.setVisible(true);
        loadInvoices();
    }//GEN-LAST:event_onAddInvoicePerformed

    private void onSelectionChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_onSelectionChanged
        if (0 > invoiceList.getSelectedIndex()) {
            detailsPane.setInvoiceId(new Integer(-1));
        } else {
            DataRow row = (DataRow) invoiceList.getModel().getElementAt(invoiceList.getSelectedIndex());
            Integer invoiceId = (Integer) row.getValue(0);
            detailsPane.setInvoiceId(invoiceId);
        }
    }//GEN-LAST:event_onSelectionChanged

    private void onDeleteInvoicePerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_onDeleteInvoicePerformed
        int selIdx = invoiceList.getSelectedIndex();
        if (0 > selIdx) {
            return;
        }
        Integer invoiceId = (Integer) ((DataRow) invoiceList.getModel().getElementAt(selIdx)).getValue(0);
        try {
            ((DefaultListModel) invoiceList.getModel()).remove(selIdx);
            InvoiceMediator.getInstance().deleteInvoice(invoiceId);
        } catch (ReelcashException e) {
            MsgBox.error(e.getLocalizedMessage());
        }
    }//GEN-LAST:event_onDeleteInvoicePerformed

    private void onPrintPreviewRequested(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_onPrintPreviewRequested
        int selInvoiceIdx = invoiceList.getSelectedIndex();
        if (0 > selInvoiceIdx) {
            MsgBox.info(InvoiceResources.getString("select_invoice"));
            return;
        }
        JasperReport report = ReportingUtils.loadReport("invoice_detailed.jasper");
        DataRow invoice = (DataRow) ((DefaultListModel) invoiceList.getModel()).getElementAt(selInvoiceIdx);
        int invoiceId = ((Integer) invoice.getValue("invoice_id")).intValue();
        JasperPrint print = ReportingUtils.fillInvoice(report, invoiceId, ReelcashDataSource.getInstance());
        ReportingUtils.showPreview(print);
    }//GEN-LAST:event_onPrintPreviewRequested

    private void issueInvoiceItemActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_issueInvoiceItemActionPerformed
        try {
            int selInvoiceIdx = invoiceList.getSelectedIndex();
            if (0 > selInvoiceIdx) {
                MsgBox.info(InvoiceResources.getString("select_invoice"));
                return;
            }
            DataRow invoice = (DataRow) ((DefaultListModel) invoiceList.getModel()).getElementAt(selInvoiceIdx);
            Integer documentId = (Integer) invoice.getValue("document_id");
            Integer invoiceId = (Integer) invoice.getValue("invoice_id");
            DocumentMediator.getInstance().setState(documentId, DocumentState.ISSUED);
            detailsPane.setInvoiceId(invoiceId);
        } catch (ReelcashException e) {
            MsgBox.exception(e);
        }
    }//GEN-LAST:event_issueInvoiceItemActionPerformed

    private void invoiceListMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_invoiceListMouseClicked
        // if right mouse button clicked (or me.isPopupTrigger())
        if (SwingUtilities.isRightMouseButton(evt)
                && !invoiceList.isSelectionEmpty()
                && invoiceList.locationToIndex(evt.getPoint())
                == invoiceList.getSelectedIndex()) {
            invoiceMenu.show(invoiceList, evt.getX(), evt.getY());
        }

    }//GEN-LAST:event_invoiceListMouseClicked
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton addButton;
    private javax.swing.JButton delButton;
    private com.google.code.reelcash.swing.invoices.JInvoiceDetailsPanel detailsPane;
    private javax.swing.JButton filterButton;
    private javax.swing.JTextField filterField;
    private javax.swing.JToolBar.Separator invOpPrevOpSep;
    private javax.swing.JList invoiceList;
    private javax.swing.JPopupMenu invoiceMenu;
    private javax.swing.JMenuItem issueInvoiceItem;
    private javax.swing.JScrollPane listScroller;
    private javax.swing.JSplitPane masterDetailPane;
    private javax.swing.JPanel masterListPanel;
    private javax.swing.JPanel masterPane;
    private javax.swing.JToolBar operationBar;
    private javax.swing.JButton previewButton;
    // End of variables declaration//GEN-END:variables
}
